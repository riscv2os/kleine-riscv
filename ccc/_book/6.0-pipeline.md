### 6. **5 級流水線架構**

Kleine-RISC-V 處理器的 5 級流水線架構是現代處理器設計中的典型結構，它將指令的執行過程分為五個不同的階段，並且允許多條指令同時在不同的階段中執行，從而提高了處理器的指令吞吐量。這五個階段分別是：取指（IF）、解碼（ID）、執行（EX）、存取（MEM）、寫回（WB）。接下來，我們會逐一介紹每個階段的功能以及數據流的運作方式。

#### 取指（IF, Instruction Fetch）

**功能**：處理器在這個階段從記憶體（通常是指令快取）中讀取當前指令，並將其傳遞到下一個階段。這個階段主要根據程式計數器（PC）的值來決定從哪個地址讀取指令。

**數據流**：
1. 程式計數器（PC）提供記憶體地址。
2. 從該地址讀取指令，並將其送到解碼單元（ID）。
3. PC 自增或被分支指令更新為新地址。

**流水線中的作用**：這是指令進入處理器的入口，它提供了後續所有階段所需的指令數據。如果在分支預測中出現錯誤，取指階段可能會被清空並重新啟動。

#### 解碼（ID, Instruction Decode）

**功能**：解碼階段將取回的指令拆解成各個部分，解析操作碼、寄存器地址等，並根據指令類型產生相應的控制信號。這個階段還會讀取需要的寄存器數據，以便在下一階段使用。

**數據流**：
1. 從取指階段接收指令，並將其拆解。
2. 從寄存器檔中讀取操作數（根據指令中的寄存器地址）。
3. 根據指令類型生成 ALU 控制信號、存取控制信號和寫回控制信號。

**流水線中的作用**：這個階段決定了指令的類型，並將其轉換為控制信號，使後續階段能正確執行指令。

#### 執行（EX, Execute）

**功能**：執行階段是處理指令的核心計算階段。它負責執行算術和邏輯運算、進行地址計算（如加法計算訪存地址）以及處理分支判斷。

**數據流**：
1. 從解碼階段接收 ALU 操作數和控制信號。
2. ALU 執行指定的運算（如加法、邏輯運算等），並將結果送到下一階段。
3. 如果是分支指令，會計算目標地址並產生分支信號。

**流水線中的作用**：在這個階段，處理器進行實際的計算操作，是整個流水線的「計算引擎」。

#### 存取（MEM, Memory Access）

**功能**：存取階段負責訪問數據記憶體，讀取或寫入數據。如果指令是讀取或寫入類型，會在這個階段進行訪存操作；如果不是訪存類型的指令，則這個階段不進行任何操作。

**數據流**：
1. 從執行階段接收計算出的記憶體地址和存取控制信號。
2. 根據指令要求，從記憶體中讀取數據或將數據寫入記憶體。
3. 將讀取到的數據傳遞到下一階段，或者將寫回地址和數據傳遞給記憶體。

**流水線中的作用**：這個階段處理與記憶體相關的指令，如讀取數據或將計算結果存入記憶體。

#### 寫回（WB, Write Back）

**功能**：寫回階段是指令執行的最後階段，它負責將 ALU 或內存的結果寫回寄存器檔，完成指令的執行過程。

**數據流**：
1. 從執行或內存階段接收結果數據。
2. 根據控制信號，將數據寫入指定的寄存器。
3. 完成該指令的處理。

**流水線中的作用**：寫回階段將結果寫回寄存器，是指令執行的終點。所有的算術、邏輯、記憶體訪問等操作的結果最終都會在這一階段反映在寄存器中。

---

#### 流水線中的數據流

在 Kleine-RISC-V 中，這五個階段同時並行執行。這意味著，在每一個時鐘週期內，不同的指令處於流水線中的不同階段，這樣可以提高處理器的整體效率。然而，流水線的並行執行可能會引發數據冒險（data hazards）和控制冒險（control hazards），這些問題必須通過額外的控制邏輯來處理，如冒險檢測單元和分支預測器。